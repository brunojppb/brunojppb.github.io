<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    
    
    
    
    
    
    
    <meta name="author" content="Bruno Paulino">
    <meta name="description" content="Making your application more robust with Exponential Backoff.">
    <meta name="keywords" content="api,js,javascript,exponential,backoff">
    <meta name="theme-color" content="#21364B">
    
    <!-- Open Graph meta properties for beautifully rendering link previews on social -->
    <!-- See: https://ogp.me/ -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://bpaulino.com/entries/retrying-api-calls-with-exponential-backoff" />
    <meta property="og:title" content="Retrying API Calls with Exponential Backoff in JavaScript" />
    <meta property="og:description" content="Making your application more robust with Exponential Backoff." />
    <meta property="og:image" content="https://bpaulino.com/assets/images/posts/2021-03-01-retrying-api-calls-with-exponential-backoff.jpg" />

    <!-- twitter card tags additive to og: meta properties -->
    <!-- See: https://developer.twitter.com/en/docs/twitter-for-websites/cards/overview/markup -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:domain" content="bpaulino.com" />
    <meta name="twitter:title" content="Retrying API Calls with Exponential Backoff in JavaScript" />
    <meta name="twitter:description" content="Making your application more robust with Exponential Backoff." />
    <meta name="twitter:image" content="https://bpaulino.com/assets/images/posts/2021-03-01-retrying-api-calls-with-exponential-backoff.jpg" />
    <meta name="twitter:url" content="https://bpaulino.com/entries/retrying-api-calls-with-exponential-backoff" />
    <meta name="twitter:creator" content="@bpaulino0" />
    <meta name="twitter:label1" content="Created by" />
    <meta name="twitter:data1" content="Bruno Paulino" />
    <meta name="twitter:label2" content="Twitter" />
    <meta name="twitter:data2" content="@bpaulino0" />
    
    
    <link rel="shortcut icon" href="/assets/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <title>Retrying API Calls with Exponential Backoff in JavaScript</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&display=swap" rel="stylesheet">
    <!-- Timestamp from jekyll build to make sure the latest version is loaded correctly on our lovely readers' clients -->
    <link rel="stylesheet" href="/assets/css/styles.css?v=1665087387">
  </head>
  <body>

    <div role="main" class="main-container">

        <div class="main-header">
  <a href="/">
    <h2>bpaulino.com</h2>
  </a>
  <p>
    Hi, I am Bruno Paulino.<br />
    Software is my craft.
  </p>
  <nav>
    <a href="/">Blog</a>
    <a href="/about">About</a>
    <a href="/courses">Courses</a>
    <!-- <a href="/speaking">Speaking</a> -->
    <a href="/reading">Reading</a>
  </nav>
  <canvas class="particles-canvas"></canvas>
</div>


        <div class="flex-wrapper">
            <div class="max-width-wrapper">
                <div class="entry-container">
    <div class="entry">
        <h1 class="entry-title">Retrying API Calls with Exponential Backoff in JavaScript</h1>
        <div style="text-align: center; font-style: italic;">March 1, 2021</div>
    	<p>Have you ever implemented an integration with a third-party service where you
have to call their API endpoints several times a day? Depending on the number of
times you call this API, some of those calls will inevitably fail.</p>

<p>One solution to mitigate this problem is to implement a <code class="language-plaintext highlighter-rouge">retry</code> algorithm. Here
is a sequence diagram showing how this algorithm could look like:</p>

<p><img src="/assets/images/posts/api-without-exponential-backoff-diagram.svg" alt="Exponential backoff diagram" /></p>

<p>Notice that once our API call fails, our app immediately tries to call it again.
That could be extremely fast and there is nothing wrong with that, but that
isn’t very effective. Why?</p>

<h2 id="being-polite-with-exponential-backoff">Being polite with Exponential Backoff</h2>

<p>Lets assume the restaurants API we were trying to call on the diagram above is
having some trouble. Maybe it’s overloaded or is completely down. Retrying to
call it immediately after a failed attempt will do no good. It will actually
make the situation worse: The restaurants API will be hammered harder and won’t
have time to recover.</p>

<p>To countermeasure that, we can wait a little before retries. We can actually do
better than that. What if on every failed attempt, we exponentially increase the
waiting time for the next attempt? Bingo, This is what
<a href="https://en.wikipedia.org/wiki/Exponential_backoff">Exponential Backoff</a> is.</p>

<blockquote>
  <ul>
    <li>Our app tries to call the Restaurants API.</li>
    <li>The API call fails.</li>
    <li>Our app waits for <code class="language-plaintext highlighter-rouge">200 millisecods</code> before calling it again.</li>
    <li>Our app retries to call the Restaurants API again.</li>
    <li>The API call fails again.</li>
    <li>Our app waits for <code class="language-plaintext highlighter-rouge">400 millisecods</code> before calling it again.</li>
    <li>Our app retries to call the Restaurants API again.</li>
    <li>The API call completes successfully.</li>
  </ul>
</blockquote>

<p>Here is how the diagram would look like when we implement Exponential Backoff:</p>

<p><img src="/assets/images/posts/api-with-exponential-backoff-diagram.svg" alt="Exponential backoff diagram" /></p>

<h2 id="how-can-we-do-that-in-javascript">How can we do that in Javascript?</h2>

<p>The implementation of the algorithm above is actually quite straightforward in
Javascript. The implementation below works in Node.js and also in modern
browsers, with zero dependencies.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Wait for the given milliseconds
 * @param {number} milliseconds The given time to wait
 * @returns {Promise} A fulfilled promise after the given time has passed
 */</span>
<span class="kd">function</span> <span class="nx">waitFor</span><span class="p">(</span><span class="nx">milliseconds</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">milliseconds</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**
 * Execute a promise and retry with exponential backoff
 * based on the maximum retry attempts it can perform
 * @param {Promise} promise promise to be executed
 * @param {function} onRetry callback executed on every retry
 * @param {number} maxRetries The maximum number of retries to be attempted
 * @returns {Promise} The result of the given promise passed in
 */</span>
<span class="kd">function</span> <span class="nx">retry</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">onRetry</span><span class="p">,</span> <span class="nx">maxRetries</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Notice that we declare an inner function here</span>
  <span class="c1">// so we can encapsulate the retries and don't expose</span>
  <span class="c1">// it to the caller. This is also a recursive function</span>
  <span class="k">async</span> <span class="kd">function</span> <span class="nx">retryWithBackoff</span><span class="p">(</span><span class="nx">retries</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// Make sure we don't wait on the first attempt</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Here is where the magic happens.</span>
        <span class="c1">// on every retry, we exponentially increase the time to wait.</span>
        <span class="c1">// Here is how it looks for a `maxRetries` = 4</span>
        <span class="c1">// (2 ** 1) * 100 = 200 ms</span>
        <span class="c1">// (2 ** 2) * 100 = 400 ms</span>
        <span class="c1">// (2 ** 3) * 100 = 800 ms</span>
        <span class="kd">const</span> <span class="nx">timeToWait</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="nx">retries</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`waiting for </span><span class="p">${</span><span class="nx">timeToWait</span><span class="p">}</span><span class="s2">ms...`</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">waitFor</span><span class="p">(</span><span class="nx">timeToWait</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">await</span> <span class="nx">promise</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// only retry if we didn't reach the limit</span>
      <span class="c1">// otherwise, let the caller handle the error</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">retries</span> <span class="o">&lt;</span> <span class="nx">maxRetries</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">onRetry</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">retryWithBackoff</span><span class="p">(</span><span class="nx">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">Max retries reached. Bubbling the error up</span><span class="dl">"</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">retryWithBackoff</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here is how you can quickly test this implementation:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** Fake an API Call that fails for the first 3 attempts
 * and resolves on its fourth attempt.
 */</span>
<span class="kd">function</span> <span class="nx">generateFailableAPICall</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Simulated error</span><span class="dl">"</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">({</span> <span class="na">status</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ok</span><span class="dl">"</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cm">/*** Testing our Retry with Exponential Backoff */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">test</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">apiCall</span> <span class="o">=</span> <span class="nx">generateFailableAPICall</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">retry</span><span class="p">(</span>
    <span class="nx">apiCall</span><span class="p">,</span>
    <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">onRetry called...</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="mi">4</span>
  <span class="p">);</span>

  <span class="nx">assert</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">ok</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">test</span><span class="p">();</span>
</code></pre></div></div>

<p>If you want to try this out, here is a
<a href="https://codesandbox.io/s/exponential-backoff-ziy8h?file=/src/index.js">Codesanbox link</a>
where you can play with it.</p>

    </div>
    <script src="/assets/js/prism.js"></script>
    <script>
    	Prism.highlightAll();
    </script>
</div>

<div id="progress-bar"></div>
            </div>
        </div>

        <footer class="main-footer fixed-bottom">
    <div class="follow-container">
        <p>
            Get in touch via <a href="https://twitter.com/bpaulino0">Twitter</a>
            / follow my <a href="/feed.xml">RSS Feed.</a>
        </p>

        <span>
            © 2022 Bruno Paulino | <a style="font-size: 12px;" href="https://github.com/brunojppb/brunojppb.github.io">This website is open-source</a>
        </span> 
    </div>
</footer>

    </div>

    <!-- Full-screen image presentation -->
    <div class="fullscreen-overlay" style="display: none;">
        <button class="close-overlay">close</button>
    </div>

    <!-- Night/Light mode switch -->
    <button id="theme-switcher" 
            aria-label="Toggle theme" 
            title="Toggle theme" 
            data-light-asset="/assets/images/sun.svg"
            data-dark-asset="/assets/images/moon.svg">
    </button>


    <!-- Minimal Blog scripts -->
    <script src="/assets/js/blog.js?v=1665087387"></script>

    <!-- Privacy-first Analytics -->
    <script data-goatcounter="https://bpaulino.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </body>
</html>